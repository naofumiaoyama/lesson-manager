# 生徒・レッスン管理システム 要件定義書

## 1. システム概要

PrimaMateria AIプログラミングスクールの生徒情報およびレッスンスケジュールを管理するWebアプリケーション。コーポレートサイトからの入会申し込みと連携し、Googleカレンダーを活用したスケジュール管理、自動メール送信機能を提供する。

## 2. 用語定義

| 用語 | 定義 |
|------|------|
| 生徒 | AIプログラミングスクールに入会した受講者 |
| 管理者 | スクールのスタッフ。生徒情報・スケジュールを管理する |
| レッスン | 生徒に対する個別またはグループの授業 |
| コミュニティ | 生徒が参加できるオンラインコミュニティ（Discord等） |

## 3. 機能要件

### 3.1 生徒登録機能（F-001）

#### 概要
コーポレートサイトのサービス申し込み（Stripe決済）完了時に、生徒情報を自動登録する。

#### 詳細要件
- F-001-01: Stripe Webhook（checkout.session.completed）をトリガーに生徒情報を登録する
- F-001-02: 登録する情報
  - 氏名
  - メールアドレス
  - 申込日時
  - 契約プラン（月額/年額）
  - Stripe顧客ID
  - ステータス（仮登録/本登録/退会）
- F-001-03: 登録完了時に管理者へ通知を送信する
- F-001-04: 生徒にはウェルカムメールを送信する

### 3.2 初回レッスン日時確定機能（F-002）

#### 概要
Googleカレンダーと連携して初回レッスンの日時を確定し、確定後にメールを送信する。

#### 詳細要件
- F-002-01: 管理者がGoogleカレンダー上で空き時間を確認できる
- F-002-02: 管理者が生徒に対して候補日時を提示できる
- F-002-03: 生徒が候補日時から希望日時を選択できる
- F-002-04: 日時確定後、Googleカレンダーに予定を自動登録する
- F-002-05: 確定通知メールをテンプレートに基づいて送信する
  - 送信先: 生徒、管理者
  - 内容: 日時、場所（オンラインURL）、準備事項

### 3.3 コミュニティ参加案内機能（F-003）

#### 概要
初回レッスン完了後に、コミュニティへの参加案内メールを自動送信する。

#### 詳細要件
- F-003-01: 初回レッスン終了（Googleカレンダーの予定終了）をトリガーにする
- F-003-02: コミュニティ招待メールをテンプレートに基づいて送信する
  - Discord招待リンク
  - 利用ガイド
- F-003-03: 生徒ステータスを「本登録」に更新する

### 3.4 レッスンスケジュール作成機能（F-004）

#### 概要
管理者が生徒のレッスンスケジュールを作成・管理する。

#### 詳細要件
- F-004-01: 定期レッスン（週次/隔週等）を設定できる
- F-004-02: 個別レッスンを追加・編集・削除できる
- F-004-03: Googleカレンダーと双方向同期する
- F-004-04: レッスンの種類を設定できる（個別/グループ）
- F-004-05: リスケジュール時に通知メールを送信する

### 3.5 生徒情報更新機能（F-005）

#### 概要
生徒が自分の情報を更新できる。

#### 詳細要件
- F-005-01: 生徒がログインして自分の情報を閲覧できる
- F-005-02: 更新可能な項目
  - 氏名
  - メールアドレス
  - パスワード
  - 連絡先（電話番号）
  - プロフィール画像
- F-005-03: メールアドレス変更時は確認メールを送信する
- F-005-04: 更新履歴を保持する

### 3.6 スケジュール確認機能（F-006）

#### 概要
生徒が自分のレッスンスケジュールを確認できる。

#### 詳細要件
- F-006-01: カレンダー形式でスケジュールを表示する
- F-006-02: リスト形式でも表示できる
- F-006-03: 過去のレッスン履歴も確認できる
- F-006-04: レッスン詳細（日時、内容、備考）を確認できる
- F-006-05: 次回レッスンのリマインダー機能

## 4. 非機能要件

### 4.1 性能要件
- ページ読み込み時間: 3秒以内
- 同時接続ユーザー数: 100人以上

### 4.2 セキュリティ要件
- HTTPS通信必須
- 認証にはJWTを使用
- パスワードはbcryptでハッシュ化
- Google OAuth2.0でのログインオプション
- CSRF対策

### 4.3 可用性要件
- 稼働率: 99.5%以上
- バックアップ: 日次

### 4.4 互換性要件
- 対応ブラウザ: Chrome, Firefox, Safari, Edge（最新2バージョン）
- レスポンシブデザイン（スマートフォン対応）

## 5. 外部連携

### 5.1 Google Calendar API
- 目的: レッスンスケジュール管理
- 連携方法: OAuth 2.0
- 必要なスコープ:
  - `https://www.googleapis.com/auth/calendar`
  - `https://www.googleapis.com/auth/calendar.events`

### 5.2 Stripe
- 目的: 決済情報との連携
- 連携方法: Webhook
- 使用するイベント:
  - `checkout.session.completed`
  - `customer.subscription.deleted`
  - `invoice.payment_failed`

### 5.3 メール送信
- 目的: 各種通知メールの送信
- 連携方法: Resend API（既存のcorporate-siteと同様）

## 6. メールテンプレート

### 6.1 ウェルカムメール
```
件名: 【PrimaMateria】ご入会ありがとうございます

{生徒名}様

PrimaMateria AIプログラミングスクールへのご入会、
誠にありがとうございます。

近日中に担当者より初回レッスンの日程調整についてご連絡いたします。

何かご不明な点がございましたら、お気軽にお問い合わせください。

PrimaMateria AIプログラミングスクール
```

### 6.2 初回レッスン確定メール
```
件名: 【PrimaMateria】初回レッスン日程のお知らせ

{生徒名}様

初回レッスンの日程が確定しましたのでお知らせいたします。

■ レッスン日時
{日時}

■ 参加方法
オンライン（Google Meet）
URL: {meeting_url}

■ 準備事項
・PCまたはタブレット
・安定したインターネット環境
・筆記用具

当日お会いできることを楽しみにしております。

PrimaMateria AIプログラミングスクール
```

### 6.3 コミュニティ参加案内メール
```
件名: 【PrimaMateria】コミュニティへようこそ

{生徒名}様

初回レッスンのご受講、ありがとうございました。

生徒専用コミュニティへの参加方法をご案内いたします。

■ Discord参加リンク
{discord_invite_url}

■ コミュニティでできること
・他の生徒との交流
・質問・相談
・学習進捗の共有
・限定イベントへの参加

ぜひご活用ください。

PrimaMateria AIプログラミングスクール
```

## 7. 画面一覧

### 7.1 管理者向け画面
| 画面ID | 画面名 | 概要 |
|--------|--------|------|
| A-001 | ダッシュボード | 全体の概要、最近の活動 |
| A-002 | 生徒一覧 | 全生徒の一覧表示・検索 |
| A-003 | 生徒詳細 | 個別生徒の詳細情報・編集 |
| A-004 | スケジュール管理 | カレンダー形式でのスケジュール管理 |
| A-005 | メールテンプレート | メールテンプレートの管理 |
| A-006 | 設定 | システム設定 |

### 7.2 生徒向け画面
| 画面ID | 画面名 | 概要 |
|--------|--------|------|
| S-001 | ログイン | 認証画面 |
| S-002 | マイページ | ダッシュボード |
| S-003 | スケジュール | 自分のレッスンスケジュール |
| S-004 | プロフィール編集 | 自分の情報編集 |

## 8. データモデル概要

### 8.1 主要エンティティ
- **生徒（students）**: 生徒の基本情報
- **レッスン（lessons）**: 個別のレッスン情報
- **スケジュール（schedules）**: 定期スケジュールの設定
- **メールログ（email_logs）**: 送信メールの履歴
- **管理者（admins）**: 管理者ユーザー

### 8.2 エンティティ関連
```
students 1---* lessons
students 1---* schedules
students 1---* email_logs
admins 1---* lessons (担当として)
```

## 9. 開発フェーズ

### Phase 1: MVP
- 生徒登録機能（Stripe連携）
- 管理者ダッシュボード
- 生徒一覧・詳細画面

### Phase 2: スケジュール機能
- Googleカレンダー連携
- 初回レッスン日時確定
- スケジュール管理

### Phase 3: 生徒向け機能
- 生徒ログイン
- プロフィール編集
- スケジュール確認

### Phase 4: 自動化・拡張
- コミュニティ参加案内の自動化
- リマインダー機能
- レポート機能
